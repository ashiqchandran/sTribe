<%- include('../partials/user/header') %>

<link href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/style/user/orders.css">

<section class="banner-area organic-breadcrumb "style="background-image: url('/images/shop/bbb.jpeg');">
    <div class="container">
        <div class="breadcrumbers">
            <a href="/">Home<span class="lnr lnr-arrow-right"></span></a>
            <a href="/orders">/orders<span class="lnr lnr-arrow-right"></span></a>
        </div>
    </div>
</section>

<!-- Main Content -->
<div class="col-md-9">
    <h2 class="mb-4">Your Orders</h2>

    <% if (orders && orders.length > 0) { %>
        <% orders.forEach(order => { %>
            <div class="order-card">
                <div class="order-header">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <small class="text-muted">ORDER PLACED</small><br>
                            <%= new Date(order.createdOn).toLocaleDateString() %>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">TOTAL</small><br>
                            ₹<%= order.finalAmount %>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">ORDER ID</small><br>
                            #<%= order.orderId %>
                        </div>
                        <div class="col-md-3">
                            <span class="status-badge <%= 
                                order.status === 'delivered' ? 'bg-success' :
                                order.status === 'cancelled' ? 'bg-danger' :
                                order.status === 'shipped' ? 'bg-info' :
                                'bg-warning'
                            %>">
                                <%= order.status.toUpperCase() %>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="order-body">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <img src="<%= order.productImage[0] %>" 
                                 alt="<%= order.productName %>"
                                 class="product-image">
                        </div>
                        <div class="col-md-6">
                            <h5><%= order.productName %></h5>
                            <p class="text-muted mb-0">Quantity: <%= order.quantity %></p>
                            <p class="text-muted">Price: ₹<%= order.price %></p>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="/order-details?orderId=<%= order.orderId %>" 
                               class="btn btn-outline-primary btn-sm">View Details</a>
                            
                            <% if (order.status !== 'cancelled' && order.status !== 'delivered') { %>
                                <button onclick="cancelOrder('<%= order.orderId%>')" 
                                        class="btn btn-outline-danger btn-sm mt-2">
                                    Cancel Order
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        <% }); %>
    <% } else { %>
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-shopping-bag fa-3x text-muted"></i>
            </div>
            <h3>No orders yet</h3>
            <p class="text-muted">When you place an order, it will appear here.</p>
            <a href="/shop" class="btn btn-primary mt-3">Start Shopping</a>
        </div>
    <% } %>

    <!-- Pagination Controls -->
    <div class="pagination">
        <% if (currentPage > 1) { %>
            <a href="?page=<%= currentPage - 1 %>" class="btn btn-outline-secondary btn-sm">Previous</a>
        <% } %>
        <% for (let i = 1; i <= totalPages; i++) { %>
            <a href="?page=<%= i %>" class="btn btn-outline-secondary btn-sm <%= i === currentPage ? 'active' : '' %>"><%= i %></a>
        <% } %>
        <% if (currentPage < totalPages) { %>
            <a href="?page=<%= currentPage + 1 %>" class="btn btn-outline-secondary btn-sm">Next</a>
        <% } %>
    </div>
</div>

<!-- SweetAlert2 for dialogs -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    async function cancelOrder(orderId) {
        const { value: reason } = await Swal.fire({
            title: 'Cancel Order',
            input: 'textarea',
            inputLabel: 'Please provide a reason for cancellation',
            inputPlaceholder: 'Type your reason here...',
            showCancelButton: true,
            inputValidator: (value) => {
                if (!value) {
                    return 'You need to provide a reason!';
                }
            }
        });

        if (reason) {
            try {
                const response = await fetch('/orders/cancel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ orderId, reason }),
                });

                const data = await response.json();
                
                if (data.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Order cancelled successfully',
                        timer: 1500
                    });
                    location.reload();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Failed to cancel order'
                });
            }
        }
    }

    function confirmLogout(event) {
        event.preventDefault(); // Prevent default link behavior

        Swal.fire({
            title: "Are you sure?",
            text: "You will be logged out!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, Logout"
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/logout"; // Redirect only if confirmed
            }
        });
    }
</script>

<%- include('../partials/user/footer') %>
