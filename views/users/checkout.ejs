 
 <%- include('../partials/user/header') %>

 <link rel="stylesheet" href="/style/user/checkout.css">

 <!-- Start Banner Area -->

<main class="hero">
    <div class="hero-content"   style="background-image: url('/images/banners/banner2.jpg');">
        <div class="col-first">    
                <a href="/">Home<span class="lnr lnr-arrow-right"></span></a>
                <a href="/cart">/Cart<span class="lnr lnr-arrow-right"></span></a>
                <a href="/checkout">/Checkout</a>            
        </div>
    </div>  
</main>
<!-- End Banner Area -->
    <style>
        
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row">
            <!-- Billing Address -->
            <div class="col-lg-8 mb-4">
                <div class="bg-white p-4 rounded shadow-sm">
                    <h2 class="h4 mb-4">Shipping Address</h2>
                    
                    <!-- Address Selection Area -->
                    <div class="form-group">
                        <label for="existingAddress">Select Existing Address</label>
                        <select id="existingAddress" class="form-control">
                            <option selected>Select an address</option>
                            <% if (userAddress && userAddress.address.length > 0) { %>
                                <% userAddress.address.forEach((address) => { %>
                                    <option value="<%= address._id %>">
                                        <%= address.addressType %> - <%= address.name %>,
                                        <%= address.streetAddress %>, <%= address.city %>, <%= address.state %>, <%= address.country %>,
                                        &#10;
                                        <%= address.phone %>
                                    </option>
                                <% }); %>
                            <% } else { %>
                                <option disabled>No addresses available</option>
                            <% } %>
                        </select>
                    </div>
                    <a href="/addAddress"><button type="button" class="btn btn-primary mt-5" id="addNewAddressBtn">Add New Address</button></a>
                    
            
                    <!-- Add New Address Button -->
                    <% if (!userAddress || userAddress.address.length === 0) { %>
                        <p  id="addNewAddressBtn">Add New Address</p>
                    <% } %>
            
                    <!-- New Address Form (hidden by default) -->
                    <div id="newAddressForm" style="display: none;">
                        <h3 class="h5 mt-4">New Address</h3>
                        <!-- Include the new address form fields here -->
                        <!-- Similar to the form structure you provided earlier -->
                    </div>
                </div>
            </div>
            
            <script>
                // JavaScript to handle the "Add New Address" button click
                document.getElementById('addNewAddressBtn').addEventListener('click', function() {
                    document.getElementById('newAddressForm').style.display = 'block';
                });
            </script>
            <!-- Order Summary -->
            <div class="col-lg-4">
                <div class="order-summary">
                    <h2 class="h4 mb-4">Your Order</h2>
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="font-weight-bold">Products</span>
                            <span class="font-weight-bold">Subtotal</span>
                        </div>
                        <% if (cartItems && cartItems.length > 0) { %>
                            <% let subtotal = 0; %>
                            <% cartItems.forEach(function(item) { %>
                                <% subtotal += item.totalPrice; %>
                                <div class="d-flex justify-content-between mb-2">
                                    <div class="d-flex align-items-center">
                                        <a style="all: unset; display: contents;" href="/productDetails?id=<%=item.product._id%>">
                                        <img src="<%= item.product.productImage[0] %>" alt="<%= item.product.productName %>">
                                        <div class="ml-2">
                                            <p class="product-name mb-0"><%= item.product.productName.split('|')[0].trim() %> (x<%= item.quantity %>)</p>
                                            <p class="product-mn mb-0"><%= item.product.category.name %></p>
                                        </div>
                                    </a>
                                    </div>
                                    <span class="product-price">₹ <%= item.totalPrice.toFixed(2) %></span>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="5" class="text-center">
                                    <p class="lead mb-4">No item found in Cart</p>
                                </td>
                            </tr>
                        <% } %>
                    </div>
                    
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal</span>
                            <span>₹ <%= subtotal.toFixed(2) %></span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Coupon Discount</span>
                            <span>(-) ₹ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Shipping</span>
                            <span>₹ 0.00</span>
                        </div>
                        <div class="text-right text-primary mb-2">
                            <a href="#" onclick="showShippingCharge(); return false;">View shipping charge</a>
                        </div>
                        <div class="d-flex justify-content-between font-weight-bold">
                            <span>Total</span>
                            <span class="total-price">₹ <%= subtotal.toFixed(2) %></span>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h3 class="h5 mb-3">Payment Method</h3>
                        <div class="mb-3">
                            <input type="text" class="form-control" placeholder="Enter coupon code here...">
                            <button class="btn apply-btn btn-block mt-2">Apply</button>
                        </div>
                        <div class="mb-3">
                            <label class="d-flex align-items-center">
                                <input type="radio" name="payment" class="mr-2">
                                <img src="./images/icons/razarpay.png" alt="PayPal" style="height: 4vh; width:12vh;">
                            </label>
                        </div>
                        <div class="mb-3">
                            <label class="d-flex align-items-center">
                                <input type="radio" name="payment" >
                                <span>wallet Payment</span>
                            </label>
                        </div>
                        <div class="mb-3">
                            <label class="d-flex align-items-center">
                                <input type="radio" name="payment" class="mr-2">
                                <span>Cash on delivery</span>
                            </label>
                        </div>
                    </div>
                    <button class="btn place-order-btn btn-block">Place Order</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

<script>
    
    
 
    
    function placeOrder() {
        const selectedAddress = document.getElementById('existingAddress');
        const paymentMethod = document.querySelector('input[name="payment"]:checked');
        
        // Check if the user has selected an address
        if (!selectedAddress || selectedAddress.value === 'Select an address') {
            Swal.fire('Error', 'Please select a shipping address', 'error');
            return;
        }

        // Check if the user has selected a payment method
        if (!paymentMethod) {
            Swal.fire('Error', 'Please select a payment method', 'error');
            return;
        }

        // Get the payment method text
        const paymentMethodSelected = paymentMethod.nextElementSibling.textContent.trim();

        if (paymentMethodSelected === 'wallet Payment') {
            // Wallet payment selected
            const totalAmount = parseFloat(document.querySelector('.total-price').textContent.replace('₹', '').trim());
            
            // Check if the wallet has enough balance
            fetch('/walletPayment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: '<%= user._id %>',  // Pass the logged-in user ID
                    amount: totalAmount,
                    addressId: selectedAddress.value,
                    
                })
                
            })
            

         
    .then(data => {
        window.location.href = `/success`;
        if (data.success) {
            // Directly redirect to the success page after successful payment
            window.location.href = `/success/${data.orderId}`;  // Ensure you use the correct orderId
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Fetch Error:', error);
        Swal.fire('Error', 'An error occurred while placing the order', 'error');
    });
        } else if (paymentMethodSelected === 'Cash on delivery') {
            // Cash on Delivery selected
            const orderData = {
                addressId: selectedAddress.value,
                paymentMethod: 'COD'
            };

            fetch('/placeOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'Order Placed Successfully!',
                        text: `Order ID: ${data.orderId}`,
                        icon: 'success',
                        confirmButtonText: 'View Order'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = `/success`;
                        }
                    });
                } else {
                    Swal.fire('Error', data.message || 'An error occurred while placing the order', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'An error occurred while placing the order', 'error');
            });
        } else if (paymentMethodSelected === 'Razorpay') {
            // Razorpay selected
            const totalAmount = parseFloat(document.querySelector('.total-price').textContent.replace('₹', '').trim());

            fetch('/checkout/razorpay-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: '<%= user %>',
                    amount: totalAmount,
                    addressId: selectedAddress.value,
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const options = {
                        key: data.razorpayKey, // Razorpay key
                        amount: totalAmount * 100, // Convert to paise
                        currency: "INR",
                        name: "Your Store",
                        description: "Order Payment",
                        order_id: data.orderId,
                        handler: function (response) {
                            fetch('/checkout/razorpay-payment-success', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    razorpayPaymentId: response.razorpay_payment_id,
                                    orderId: data.orderId,
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    Swal.fire({
                                        title: 'Payment Successful!',
                                        text: `Order ID: ${data.orderId}`,
                                        icon: 'success',
                                        confirmButtonText: 'View Order'
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            window.location.href = `/order-details/${data.orderId}`;
                                        }
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                Swal.fire('Error', 'An error occurred while processing the  Razor ay payment', 'error');
                            });
                        },
                        prefill: {
                            name: "Customer Name",
                            email: "customer@example.com",
                            contact: "+919876543210",
                        },
                        theme: {
                            color: "#F37254",
                        },
                    };
                    const razorpay = new Razorpay(options);
                    razorpay.open();
                } else {
                    Swal.fire('Error', data.message || 'An error occurred while initiating Razorpay payment', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'An error occurred while processing the Razorpay payment', 'error');
            });
        } else {
            // Handle any unsupported payment methods
            Swal.fire('Error', 'Unsupported payment method selected', 'error');
        }
    }

    // Update the place order button onclick handler
    document.querySelector('.place-order-btn').onclick = placeOrder;


</script>

<%- include('../partials/user/footer') %>